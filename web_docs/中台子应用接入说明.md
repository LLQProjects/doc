# 子应用接入说明

## 1 子应用需求

* 其他业务团队独立开发，构建
* 主框架与应用间保持通信
* 保持js，css隔离（避免不同开发部门，js污染，样式冲突）
* 保持风格统一，路由无感知刷新：约定技术栈（UI库），看起来中台是由一个部门开发。

基于以上需求，所以主框架采用微前端（基座 + 子应用），而不是iframe等方案。

更具体的方案选型详细见  

* [业务中台前端架构选型](20210722-业务中台前端架构-林连强.md)

## 2 子应用接入须知

### 2.1 问题

因为采用的是微前端方案，目前成熟的微前端框架只有qiankun、Single-SPA。自主实现微前端方案，需要耗费一定的成本。

固采用qiankun框架。同时也存在一些问题：

* 微前端使用场景复杂，没有完美的沙箱方案,当子应用使用一些第三方js文件时，通常无法有效控制js的表现。
* 子应用的样式完全隔离。但主框架的全局样式会渗透到子应用。
* 微前端不限定子应用的技术栈。造成组件无法复用，风格难以统一。
* ...

* [子应用接入常见问题及解决方案](中台子应用接入常见问题及解决方案.md)

### 2.2 约定

为了让子应用以最低的成本接入主框架，需遵守如下约定：

* 子应用需用bmp-cli脚手架创建模板。（确定UI库，重写elementUI样式，确定路由模式，确定技术栈，默认导出生命周期，通过props共享vuex）

* 主框架全局样式，class命名默认采用 cocos-micro-* 前缀。子应用应避免使用该命名

* qiankun框架没有解决元素隔离。所以子应用应避免直接操作DOM。

  ```js
  // 子应用禁止如下操作：
  var eleRoot = document.getElementById('主框架id')
  eleRoot.appendChild()
  eleRoot.innerHTML = '...'
  ...
  ```

* 所有的资源（图片/音频等）都应该放到src目录，不放在public。在src目录，会经过webpack处理，能统一注入 `publicPath`。否则在主项目中会404。
* `js` 沙箱只劫持了 `window.addEventListener`，使用 `document.body.addEventListener` 或者 `document.body.onClick` 添加的事件并不会被沙箱移除，会对其他的页面产生影响，请在 `unmount` 周期清除。

## 3. 快速接入子应用

